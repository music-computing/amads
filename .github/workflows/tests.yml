name: Tests

env:
  # This is needed for R's install_github scripts
  GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  tests_main:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Run pre-commit checks
      run: |
        pip install pre-commit
        pre-commit run --all-files || (cat .github/pre-commit-error-message.txt && exit 1)

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[test]

    - name: Debug - Show file structure
      run: |
        pwd
        ls -la
        find . -name "*.mid" -o -name "*.mid*"
        echo "Python working directory:"
        python -c "import os; print(os.getcwd())"

    - name: Run tests with coverage
      run: |
        python -c "from amads.ci import run_main_tests; run_main_tests()"

    - name: Upload coverage to Codecov
      if: success() && matrix.python-version == '3.11'
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: true
        flags: python-tests

# not sure why melsim tests are not running or sure they ever did
# but probably related to R installation. I don't think it's important
# to run these (or really, any "ci" tests -- what's the point except
# maybe to measure coverage, since we should be testing before commits)
#
#   tests_melsim:
#     runs-on: ubuntu-latest
# 
#     steps:
#     - uses: actions/checkout@v4
# 
#     - name: Set up Python
#       uses: actions/setup-python@v4
#       with:
#         python-version: "3.11"
# 
#     - name: Install Python packages
#       run: |
#         # pip install -e .[test,melsim]
#         pip install -e .[test]
#         pip install typing_extensions
# 
#     - name: Upload coverage to Codecov
#       if: success()
#       uses: codecov/codecov-action@v5
#       with:
#         token: ${{ secrets.CODECOV_TOKEN }}
#         fail_ci_if_error: true
#         flags: melsim-tests
